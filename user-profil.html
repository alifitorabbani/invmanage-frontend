<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>InvManage - Profil</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="dashboard-layout">

    <!-- Sidebar -->
    <div class="sidebar">
      <img src="image.png" alt="Logo" class="sidebar-logo">
      <h1>InvManage</h1>

      <div class="menu">
        <a href="user-dashboard.html" class="menu-item">Daftar Barang</a>
        <a href="user-peminjaman.html" class="menu-item">Peminjaman Saya</a>
        <a href="user-feedback.html" class="menu-item">Feedback</a>
        <a href="user-profil.html" class="menu-item active">Profil</a>
      </div>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <h2 style="margin-bottom:5px; font-size: 28px; font-weight: 700; color: var(--gray-100);">Profil Pengguna</h2>
      <p style="color:var(--gray-400); margin-bottom:30px; font-size: 16px;">Kelola informasi akun anda</p>

      <!-- Profile Header Card -->
      <div class="profile-header-card">
        <div class="profile-photo-container">
          <img id="profilePhoto" src="" alt="Profile" class="profile-photo">
          <label for="photoInput" class="photo-edit-btn">ðŸ“·</label>
          <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="previewPhoto(this)">
        </div>
        <div class="profile-info">
          <div id="profileNamaHeader" class="profile-name">User</div>
          <div id="profileRoleHeader" class="profile-role">User</div>
        </div>
      </div>

      <!-- Account Info Card -->
      <div class="table-box" style="margin-top:30px;">
        <div class="table-header">
          <div>
            <h3 style="margin:0; font-size: 20px; font-weight: 600; color: var(--gray-100);">Informasi Akun</h3>
            <p style="color:var(--gray-400); margin:5px 0 0 0; font-size:14px;">Update data pribadi anda</p>
          </div>
          <button class="add-btn" onclick="toggleEditMode()">Edit</button>
        </div>

        <div class="profile-form">
          <div class="form-row">
            <div class="input-group">
              <label>Nama Lengkap</label>
              <input type="text" id="inputNama" placeholder="Nama lengkap" disabled>
            </div>
            <div class="input-group">
              <label>Username</label>
              <input type="text" id="inputUsername" placeholder="Username" disabled>
            </div>
          </div>

          <div class="form-row">
            <div class="input-group">
              <label>Email</label>
              <input type="email" id="inputEmail" placeholder="Email" disabled>
            </div>
            <div class="input-group">
              <label>No. Telepon</label>
              <input type="text" id="inputPhone" placeholder="No. Telepon" disabled>
            </div>
          </div>

          <div class="form-row">
            <div class="input-group" style="flex:1;">
              <label>Departemen</label>
              <input type="text" id="inputDepartemen" placeholder="Departemen" disabled>
            </div>
          </div>

          <div id="saveButtons" style="display:none; margin-top:15px;">
            <button class="primary" onclick="saveProfil()">Simpan Perubahan</button>
            <button class="btn-red" style="margin-left:10px;" onclick="cancelEdit()">Batal</button>
          </div>
        </div>
      </div>

      <!-- Change Password Card -->
      <div class="table-box" style="margin-top:30px;">
        <div class="table-header">
          <div>
            <h3 style="margin:0; font-size: 20px; font-weight: 600; color: var(--gray-100);">Ganti Password</h3>
            <p style="color:var(--gray-400); margin:5px 0 0 0; font-size:14px;">Perbarui password akun anda</p>
          </div>
        </div>
        
        <div class="form-row">
          <div class="input-group">
            <label>Password Lama</label>
            <input type="password" id="inputOldPassword" placeholder="Masukkan password lama">
          </div>
          <div class="input-group">
            <label>Password Baru</label>
            <input type="password" id="inputNewPassword" placeholder="Masukkan password baru">
          </div>
        </div>

        <div class="form-row">
          <div class="input-group">
            <label>Konfirmasi Password Baru</label>
            <input type="password" id="inputConfirmPassword" placeholder="Konfirmasi password baru">
          </div>
          <div class="input-group" style="display:flex; align-items:flex-end;">
            <button class="primary" onclick="changePassword()">Ubah Password</button>
          </div>
        </div>
      </div>

      <!-- Logout Button -->
      <div style="margin-top:20px;">
        <button class="btn-red" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Copyright Footer -->
  <footer class="copyright-footer">
    <p>&copy; 2025 InvManage. All rights reserved.</p>
    <div class="copyright-team">
      <div class="team-member">
        <div class="team-role">Software Architect & Developer</div>
        <div class="team-name">
          <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/eDuxj6_KTmf6YPT4mS22ImxLcI2AMpeH-UDBV4sZj3dkDlM-mOCRH1tohrHDnMuLchCNVg==" target="_blank">
            Alifito Rabbani Cahyono
          </a>
        </div>
      </div>
      <div class="team-member">
        <div class="team-role">UI/UX Architect & Developer</div>
        <div class="team-name">
          <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/NOLSmx8LbYciDdNeAiC78KLe0D79FgZs3AQQ-Rp0U9MwtQK3A48MEeHOf-_ZwbtJOMFwxw==" target="_blank">
            Satria Febry Andanu
          </a>
        </div>
      </div>
      <div class="team-member">
        <div class="team-role">Data Analyst & Engineer</div>
        <div class="team-name">
          <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/mhbV5ChTDJtuFBK7x0DFSQMCI7JObDTv_hYV9KHaAA3_Xioi_j3PO2C4_oiCFjQwte-7Ig==" target="_blank">
            Naufal Thafhan
          </a>
        </div>
      </div>
    </div>
  </footer>

  <script src="app.js?v=20251226"></script>
  <script>
    // User Profile Functions
    let isEditMode = false;

    function loadProfilFull() {
      const currentUser = getCurrentUser();
      if (!currentUser) return;

      // Header
      if ($("#profileNamaHeader")) $("#profileNamaHeader").textContent = currentUser.nama || "User";
      if ($("#profileRoleHeader")) {
        $("#profileRoleHeader").textContent = "Standard User";
      }

      // Photo
      const photoEl = $("#profilePhoto");
      if (photoEl) {
        if (currentUser.foto) {
          photoEl.src = currentUser.foto;
          photoEl.style.background = 'none';
        } else {
          // Show initials
          const initials = getInitials(currentUser.nama || "U");
          photoEl.src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect fill="%237c8db5" width="80" height="80"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="32" font-family="Arial">${initials}</text></svg>`;
        }
      }

      // Form fields
      if ($("#inputNama")) $("#inputNama").value = currentUser.nama || "";
      if ($("#inputUsername")) $("#inputUsername").value = currentUser.username || "";
      if ($("#inputEmail")) $("#inputEmail").value = currentUser.email || "";
      if ($("#inputPhone")) $("#inputPhone").value = currentUser.phone || "";
      if ($("#inputDepartemen")) $("#inputDepartemen").value = currentUser.departemen || "";
    }

    function getInitials(name) {
      const parts = name.split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }

    function toggleEditMode() {
      isEditMode = !isEditMode;
      const inputs = document.querySelectorAll('.profile-form input');
      const saveButtons = $("#saveButtons");

      inputs.forEach(input => {
        input.disabled = !isEditMode;
      });

      if (saveButtons) {
        saveButtons.style.display = isEditMode ? 'block' : 'none';
      }
    }

    function cancelEdit() {
      isEditMode = false;
      const inputs = document.querySelectorAll('.profile-form input');
      const saveButtons = $("#saveButtons");

      inputs.forEach(input => {
        input.disabled = true;
      });

      if (saveButtons) {
        saveButtons.style.display = 'none';
      }

      loadProfilFull(); // Reset values
    }

    async function saveProfil() {
      const currentUser = getCurrentUser();
      if (!currentUser) return;

      const payload = {
        nama: $("#inputNama")?.value || currentUser.nama,
        username: $("#inputUsername")?.value || "",
        email: $("#inputEmail")?.value || "",
        phone: $("#inputPhone")?.value || "",
        departemen: $("#inputDepartemen")?.value || "",
      };

      try {
        const res = await fetch(`${API_BASE}/users/${currentUser.id}/`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (res.ok) {
          const updatedUser = await res.json();
          setCurrentUser(updatedUser);
          cancelEdit();
          loadProfilFull();
          showNotification("Profil berhasil disimpan", "success");
        } else {
          showNotification("Gagal menyimpan profil", "error");
        }
      } catch (err) {
        console.error(err);
        showNotification("Gagal menyimpan profil", "error");
      }
    }

    // Preview and upload photo
    function previewPhoto(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64 = e.target.result;

          // Update preview
          const photoEl = $("#profilePhoto");
          if (photoEl) {
            photoEl.src = base64;
          }

          // Save to server
          await uploadPhoto(base64);
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function uploadPhoto(base64) {
      const currentUser = getCurrentUser();
      if (!currentUser) return;

      try {
        const res = await fetch(`${API_BASE}/users/${currentUser.id}/update_foto/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ foto: base64 }),
        });

        if (res.ok) {
          const data = await res.json();
          setCurrentUser(data.user);
          showNotification("Foto profil berhasil diubah", "success");
        } else {
          showNotification("Gagal mengubah foto profil", "error");
        }
      } catch (err) {
        console.error(err);
        showNotification("Gagal mengubah foto profil", "error");
      }
    }

    async function changePassword() {
      const currentUser = getCurrentUser();
      if (!currentUser) return;

      const oldPassword = $("#inputOldPassword")?.value;
      const newPassword = $("#inputNewPassword")?.value;
      const confirmPassword = $("#inputConfirmPassword")?.value;

      if (!oldPassword || !newPassword || !confirmPassword) {
        showNotification("Semua field password wajib diisi", "warning");
        return;
      }

      if (newPassword !== confirmPassword) {
        showNotification("Password baru dan konfirmasi tidak cocok", "error");
        return;
      }

      if (newPassword.length < 4) {
        showNotification("Password baru minimal 4 karakter", "warning");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/users/${currentUser.id}/change_password/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            old_password: oldPassword,
            new_password: newPassword
          }),
        });

        const data = await res.json();

        if (res.ok && data.success) {
          showNotification("Password berhasil diubah", "success");
          // Clear password fields
          if ($("#inputOldPassword")) $("#inputOldPassword").value = "";
          if ($("#inputNewPassword")) $("#inputNewPassword").value = "";
          if ($("#inputConfirmPassword")) $("#inputConfirmPassword").value = "";
        } else {
          showNotification(data.error || "Gagal mengubah password", "error");
        }
      } catch (err) {
        console.error(err);
        showNotification("Gagal mengubah password", "error");
      }
    }

    function logout() {
      const currentUser = getCurrentUser();

      // Clear welcome notification flags
      if (currentUser) {
        localStorage.removeItem(`welcome_shown_${currentUser.id}`);
        localStorage.removeItem(`welcome_shown_user_${currentUser.id}`);
      }

      clearCurrentUser();
      localStorage.removeItem("profileNama");
      localStorage.removeItem("profileEmail");

      // Redirect to landing page
      window.location.href = "index.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Temporarily bypass auth for testing - REMOVE THIS IN PRODUCTION
      // if (!checkAuth('user')) return;
      loadProfilFull();
    });
  </script>
</body>
</html>
