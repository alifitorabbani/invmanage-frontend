<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>InvManage - Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Welcome Notification -->
  <div id="welcomeNotification" class="welcome-message">
    <h3 id="welcomeTitle">Selamat!</h3>
    <p id="welcomeMessage"></p>
  </div>

  <div class="dashboard-layout">

    <!-- Sidebar -->
    <div class="sidebar">
      <img src="image.png" alt="Logo" class="sidebar-logo">
      <h1>InvManage Admin</h1>

      <div class="menu">
          <a href="dashboard.html" class="menu-item active">Dashboard</a>
          <a href="riwayat.html" class="menu-item">Riwayat Transaksi</a>
          <a href="laporan.html" class="menu-item">üìä Laporan & Analitik</a>
          <a href="profil.html" class="menu-item">Profil</a>
          <a href="feedback.html" class="menu-item">Feedback</a>
      </div>
    </div>

    <!-- Main content -->
    <div class="main-content">

      <!-- Cards -->
      <div class="card-container">
        <div class="card">
          <h3>Total Item</h3>
          <div class="card-number" id="cardTotalItem">0</div>
        </div>
        <div class="card">
          <h3>Stok rendah</h3>
          <div class="card-number" id="cardStokRendah" style="color:red;">0</div>
        </div>
        <div class="card">
          <h3>Hampir habis</h3>
          <div class="card-number" id="cardHampirHabis" style="color:orange;">0</div>
        </div>
        <div class="card">
          <h3>Stok Aman</h3>
          <div class="card-number" id="cardStokAman" style="color:green;">0</div>
        </div>
      </div>

      <!-- Table Barang -->
      <div class="table-box">
        <div class="table-header">
          <div>
            <h2 class="table-title">Manajemen Stok</h2>
            <p style="color:#64748b; margin: 8px 0 0 0; font-size: 14px;">Kelola dan pantau stok barang secara real-time</p>
          </div>
          <button class="add-btn" onclick="openBarangModal('add')">+ Tambah Stok</button>
        </div>

        <div class="input-group" style="max-width:350px; margin-bottom:20px;">
          <input type="text" id="searchBarang" placeholder="Cari barang...">
        </div>

        <!-- CRUD Status Indicator -->
        <div id="crudStatus" style="display: none; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 8px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; font-weight: 600;">
          ‚úÖ CRUD Functionality Active - Ready to manage inventory
        </div>

        <table id="tabelBarang">
          <thead>
            <tr>
              <th>Nama Barang</th>
              <th>Stok Saat Ini</th>
              <th>Minimum</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            <!-- diisi lewat app.js -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Tambah/Edit Barang -->
  <div class="modal-bg" id="modalBarang">
    <div class="modal">
      <h3 id="modalBarangTitle">Tambah Stok Barang</h3>

      <div class="input-group">
        <label for="formBarangNama">Nama Barang <span style="color: #ef4444;">*</span></label>
        <input type="text" id="formBarangNama" placeholder="Masukkan nama barang" required>
      </div>

      <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1;">
          <label for="formBarangStok">Stok Saat Ini <span style="color: #ef4444;">*</span></label>
          <input type="number" id="formBarangStok" placeholder="0" min="0" required>
        </div>
        <div class="input-group" style="flex:1;">
          <label for="formBarangMinimum">Stok Minimum</label>
          <input type="number" id="formBarangMinimum" placeholder="5" min="0" value="5">
          <small style="color: #6b7280; font-size: 12px;">Notifikasi jika stok di bawah nilai ini</small>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="primary" onclick="saveBarang()">Simpan</button>
        <button class="btn-red" onclick="closeBarangModal()">Batal</button>
      </div>
    </div>
  </div>

  <!-- Modal Hapus Barang -->
  <div class="modal-bg" id="modalDeleteBarang">
    <div class="modal">
      <h3>Hapus Data Barang</h3>
      <p>Hapus data barang <strong id="deleteNamaBarang"></strong>?</p>

      <div class="modal-buttons">
        <button class="btn-green" onclick="closeDeleteBarang()">Tidak</button>
        <button class="btn-red" onclick="confirmDeleteBarang()">Ya</button>
      </div>
    </div>
  </div>

  <!-- Copyright Footer -->
  <footer class="copyright-footer">
    <p>&copy; 2025 InvManage. All rights reserved.</p>
    <div class="copyright-team">
      <div class="team-member">
        <div class="team-role">Software Architect & Developer</div>
        <div class="team-name">
          <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/eDuxj6_KTmf6YPT4mS22ImxLcI2AMpeH-UDBV4sZj3dkDlM-mOCRH1tohrHDnMuLchCNVg==" target="_blank">
            Alifito Rabbani Cahyono
          </a>
        </div>
      </div>
      <div class="team-member">
        <div class="team-role">UI/UX Architect & Developer</div>
        <div class="team-name">
          <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/NOLSmx8LbYciDdNeAiC78KLe0D79FgZs3AQQ-Rp0U9MwtQK3A48MEeHOf-_ZwbtJOMFwxw==" target="_blank">
            Satria Febry Andanu
          </a>
        </div>
      </div>
      <div class="team-member">
        <div class="team-role">Data Analyst & Engineer</div>
        <div class="team-name">
          <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/mhbV5ChTDJtuFBK7x0DFSQMCI7JObDTv_hYV9KHaAA3_Xioi_j3PO2C4_oiCFjQwte-7Ig==" target="_blank">
            Naufal Thafhan
          </a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // Ensure all CRUD functions are available before DOMContentLoaded
    function ensureCrudFunctions() {
      const requiredFunctions = [
        'checkAuth', 'getCurrentUser', 'loadBarang', 'applyBarangFilter',
        'openBarangModal', 'closeBarangModal', 'saveBarang', 'openDeleteBarang',
        'closeDeleteBarang', 'confirmDeleteBarang'
      ];

      const missingFunctions = requiredFunctions.filter(fn => typeof window[fn] !== 'function');
      if (missingFunctions.length > 0) {
        console.error('Missing required functions:', missingFunctions);
        return false;
      }
      return true;
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Immediate initialization without waiting
      const initDashboard = () => {
        // Temporarily bypass auth for testing - REMOVE THIS IN PRODUCTION
        // if (!checkAuth('admin')) return;

        console.log('Dashboard initialization starting...');

        // Show welcome message immediately if needed
        const currentUser = getCurrentUser();
        const welcomeMessage = document.getElementById('welcomeMessage');
        const welcomeNotification = document.getElementById('welcomeNotification');
        const welcomeShownKey = `welcome_shown_admin_${currentUser?.id || 'unknown'}`;
        const welcomeAlreadyShown = localStorage.getItem(welcomeShownKey);

        if (welcomeMessage && welcomeNotification && !welcomeAlreadyShown && currentUser) {
          localStorage.setItem(welcomeShownKey, 'true');
          const userName = currentUser.nama || 'Admin';
          welcomeMessage.textContent = `${userName} telah berhasil login sebagai admin`;

          welcomeNotification.style.display = 'block';
          welcomeNotification.style.opacity = '0';
          welcomeNotification.style.transform = 'translateY(-20px)';

          // Use requestAnimationFrame for smoother animation
          requestAnimationFrame(() => {
            welcomeNotification.style.transition = 'all 0.5s ease';
            welcomeNotification.style.opacity = '1';
            welcomeNotification.style.transform = 'translateY(0)';
          });

          // Hide after 5 seconds
          setTimeout(() => {
            welcomeNotification.style.opacity = '0';
            welcomeNotification.style.transform = 'translateY(-20px)';
            setTimeout(() => {
              welcomeNotification.style.display = 'none';
            }, 500);
          }, 5000);
        }

        // Search functionality is initialized in app.js

        // Load data immediately for instant response
        loadBarang();

        console.log('Dashboard initialization complete');
      };

      // Check if functions are available, but don't wait
      if (typeof checkAuth === 'function' && typeof getCurrentUser === 'function' &&
          typeof loadBarang === 'function' && typeof applyBarangFilter === 'function') {
        initDashboard();
      } else {
        // Fallback: wait briefly for functions to load
        setTimeout(initDashboard, 200);
      }
    });

    // Enhanced keyboard shortcuts for modal
    document.addEventListener("keydown", (e) => {
      const modal = document.getElementById("modalBarang");
      if (modal && modal.style.display === "flex") {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          if (typeof saveBarang === 'function') {
            saveBarang();
          }
        } else if (e.key === "Escape") {
          if (typeof closeBarangModal === 'function') {
            closeBarangModal();
          }
        }
      }

      const deleteModal = document.getElementById("modalDeleteBarang");
      if (deleteModal && deleteModal.style.display === "flex") {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          if (typeof confirmDeleteBarang === 'function') {
            confirmDeleteBarang();
          }
        } else if (e.key === "Escape") {
          if (typeof closeDeleteBarang === 'function') {
            closeDeleteBarang();
          }
        }
      }
    });

    // Optimized button click handlers with debouncing
    let lastClickTime = 0;
    document.addEventListener('click', (e) => {
      const now = Date.now();
      if (now - lastClickTime < 200) return; // Prevent rapid clicks
      lastClickTime = now;

      if (e.target.matches('[onclick*="openBarangModal"]')) {
        console.log('‚ûï Add/Edit button clicked');
        e.target.style.background = '#10b981'; // Visual feedback
        setTimeout(() => e.target.style.background = '', 200);
      }
      if (e.target.matches('[onclick*="openDeleteBarang"]')) {
        console.log('üóëÔ∏è Delete button clicked');
        e.target.style.background = '#ef4444';
        setTimeout(() => e.target.style.background = '', 200);
      }
      if (e.target.matches('[onclick*="saveBarang"]')) {
        console.log('üíæ Save button clicked');
        e.target.style.transform = 'scale(0.95)';
        setTimeout(() => e.target.style.transform = '', 200);
      }
    });

    // Test CRUD functionality
    window.testCrud = function() {
      console.log('üß™ Testing CRUD functionality...');

      let crudAvailable = true;

      // Test modal opening
      if (typeof openBarangModal === 'function') {
        console.log('‚úÖ openBarangModal function available');
        openBarangModal('add');
        setTimeout(() => {
          if (typeof closeBarangModal === 'function') {
            closeBarangModal();
            console.log('‚úÖ Modal open/close test passed');
          }
        }, 1000);
      } else {
        console.error('‚ùå openBarangModal function not available');
        crudAvailable = false;
      }

      // Test data loading
      if (typeof loadBarang === 'function') {
        console.log('‚úÖ loadBarang function available');
      } else {
        console.error('‚ùå loadBarang function not available');
        crudAvailable = false;
      }

      // Test save function
      if (typeof saveBarang === 'function') {
        console.log('‚úÖ saveBarang function available');
      } else {
        console.error('‚ùå saveBarang function not available');
        crudAvailable = false;
      }

      // Show status indicator
      const statusEl = document.getElementById('crudStatus');
      if (crudAvailable) {
        statusEl.style.display = 'block';
        statusEl.innerHTML = '‚úÖ CRUD Functionality Active - Ready to manage inventory';
        statusEl.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        showNotification('CRUD functionality is working properly!', 'success');
      } else {
        statusEl.style.display = 'block';
        statusEl.innerHTML = '‚ùå CRUD Functionality Issues - Check console for details';
        statusEl.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        showNotification('Some CRUD functions may not be working. Check console.', 'error');
      }

      showNotification('CRUD test completed. Check console for details.', 'info');
    };

    // Auto-test removed to prevent delays - manual testing available via testCrud()
  </script>
  <script src="app.js"></script>
</body>
</html>
