<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <title>InvManage - Admin Login</title>
</head>
<body>

<!-- Animated Background Elements -->
<div class="bg-elements">
  <div class="bg-circle bg-circle-1"></div>
  <div class="bg-circle bg-circle-2"></div>
  <div class="bg-circle bg-circle-3"></div>
  <div class="floating-shapes">
    <div class="shape shape-1">‚¨°</div>
    <div class="shape shape-2">‚¨¢</div>
    <div class="shape shape-3">‚¨£</div>
    <div class="shape shape-4">‚ñ≠</div>
  </div>
</div>

<div id="authContainer" class="center-box">
  <!-- Enhanced Logo Section -->
  <div class="logo-container">
    <div class="logo-glow">
      <img src="image.png" alt="Logo" class="logo">
    </div>
    <div class="logo-particles">
      <span></span><span></span><span></span><span></span><span></span>
    </div>
  </div>

  <!-- Enhanced Header -->
  <div class="header-content">
    <h2 class="main-title">
      <span class="title-gradient">InvManage</span>
      <span class="title-accent">Admin</span>
    </h2>
    <p class="subtitle">
      Administrator Login Panel
    </p>
    <div class="feature-badges">
      <span class="badge">Secure Access</span>
      <span class="badge">Admin Panel</span>
      <span class="badge">Full Control</span>
    </div>
  </div>

  <!-- Role Indicator -->
  <div class="role-indicator">
    <span class="role-badge admin">Administrator</span>
    <button class="change-role-btn" onclick="goToUserLogin()">Switch to User Login</button>
  </div>

  <!-- Enhanced Tabs -->
  <div class="tabs">
    <button class="tab active" id="tabLogin">
      <span class="tab-text">Login Admin</span>
    </button>
    <button class="tab inactive" id="tabRegister">
      <span class="tab-text">Register Admin</span>
    </button>
  </div>

  <!-- Enhanced Login Form -->
  <div id="loginForm" class="form-container">
    <div class="form-header">
      <h3>Login Administrator</h3>
      <p>Masuk ke panel kontrol sistem InvManage</p>
    </div>

    <div class="input-group">
      <label>
        Username Admin
      </label>
      <input type="text" id="loginUsername" placeholder="Enter admin username">
      <div class="input-underline"></div>
    </div>

    <div class="input-group">
      <label>
        Password Admin
      </label>
      <input type="password" id="loginPassword" placeholder="Enter admin password">
      <div class="input-underline"></div>
    </div>

    <div class="form-options">
      <label class="remember-me">
        <input type="checkbox" id="rememberMe">
        <span class="checkmark"></span>
        Ingat saya
      </label>
      <a href="#" class="forgot-password">Lupa password?</a>
    </div>

    <button class="primary login-btn" onclick="doAdminLogin()">
      <span class="btn-content">
        <span class="btn-text">Access Admin Panel</span>
      </span>
    </button>

    <div class="divider">
      <span>or</span>
    </div>

    <div class="social-login">
      <button class="social-btn google-btn">
        Continue with Google (Admin)
      </button>
    </div>
  </div>

  <!-- Enhanced Register Form -->
  <div id="registerForm" class="form-container" style="display:none;">
    <div class="form-header">
      <h3>Daftar sebagai Administrator</h3>
      <p>Buat akun admin untuk mengelola sistem InvManage</p>
    </div>

    <div class="input-group">
      <label>
        Username Admin
      </label>
      <input type="text" id="registerUsername" placeholder="Choose unique admin username">
      <div class="input-underline"></div>
    </div>

    <div class="input-group">
      <label>
        Email Admin
      </label>
      <input type="email" id="registerEmail" placeholder="Enter admin email @gmail.com">
      <div class="input-underline"></div>
    </div>

    <div class="input-group">
      <label>
        Password Admin
      </label>
      <input type="password" id="registerPassword" placeholder="Create strong admin password">
      <div class="input-underline"></div>
    </div>

    <div class="terms-agreement">
      <label class="checkbox-container">
        <input type="checkbox" id="agreeTerms" required>
        <span class="checkmark"></span>
        Saya setuju dengan <a href="admin-terms.html" target="_blank" class="terms-link">Syarat & Ketentuan</a> untuk admin
      </label>
    </div>

    <button class="primary register-btn" onclick="doAdminRegister()">
      <span class="btn-content">
        <span class="btn-text">Create Admin Account</span>
      </span>
    </button>

    <div class="divider">
      <span>or</span>
    </div>

    <div class="social-login">
      <button class="social-btn google-btn">
        Register with Google (Admin)
      </button>
    </div>

    <div class="form-footer">
      <p>Sudah punya akun admin? <a href="#" onclick="switchToLogin()">Masuk di sini</a></p>
    </div>
  </div>
</div>

<!-- Reset Password Modal -->
<div id="resetPasswordModal" class="modal-bg">
  <div class="modal">
    <h3>Reset Admin Password</h3>
    <p>Enter your admin email to receive password reset link</p>

    <div class="input-group">
      <label>
        Email Admin
      </label>
      <input type="email" id="resetEmail" placeholder="Enter admin email @gmail.com">
      <div class="input-underline"></div>
    </div>

    <div class="modal-buttons">
      <button class="btn-red" onclick="closeResetModal()">Batal</button>
      <button class="btn-green" onclick="sendResetEmail()">Kirim Link Reset</button>
    </div>
  </div>
</div>

<!-- Success Modal for Reset -->
<div id="resetSuccessModal" class="modal-bg">
  <div class="modal">
    <h3>‚úÖ Link Reset Terkirim!</h3>
    <p>Kami telah mengirimkan link reset password ke email admin Anda. Silakan periksa inbox Anda dan ikuti instruksi untuk mereset password.</p>

    <div class="modal-buttons">
      <button class="btn-green" onclick="closeResetSuccessModal()">Tutup</button>
    </div>
  </div>
</div>

<!-- Welcome Message -->
<div class="welcome-message">
  <h3>Welcome to InvManage Admin Panel</h3>
  <p>Manage inventory system with full control and administrator access</p>
</div>

<script>
  // Admin-specific login function
  async function doAdminLogin() {
    const nama = document.getElementById("loginUsername")?.value?.trim();
    const password = document.getElementById("loginPassword")?.value;
    const loginBtn = document.getElementById("loginForm")?.querySelector("button.primary");

    if (!nama || !password) {
      showNotification("Username dan password admin wajib diisi", "warning");
      return;
    }

    // Show loading state
    if (loginBtn) {
      loginBtn.disabled = true;
      loginBtn.innerHTML = `
        <span style="display: inline-flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: enterpriseSpin 1s linear infinite;"></div>
          Sedang Masuk...
        </span>
      `;
    }

    try {
      const res = await fetch(`${API_BASE}/admin/login/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nama, password }),
      });

      if (!res.ok) {
        if (loginBtn) {
          loginBtn.disabled = false;
          loginBtn.innerHTML = `
            <span class="btn-content">
              <span class="btn-icon">üëë</span>
              <span class="btn-text">Masuk ke Admin Panel</span>
            </span>
          `;
        }

        if (res.status === 400) {
          const errorData = await res.json();
          showNotification(errorData.error || "Username atau password admin salah", "error");
          return;
        } else if (res.status >= 500) {
          showNotification("Server mengalami masalah. Coba lagi nanti.", "error");
          return;
        } else {
          showNotification("Gagal terhubung ke server", "error");
          return;
        }
      }

      const data = await res.json();

      if (data.success) {
        // Check if user has admin role
        if (data.user.role !== 'admin') {
          showNotification("Akun ini bukan akun administrator. Silakan gunakan halaman login user.", "error");
          return;
        }

        // Set user access level based on login page (admin dashboard access)
        const userWithAccess = { ...data.user, accessLevel: 'admin' };
        setCurrentUser(userWithAccess);
        showNotification("Login admin berhasil! Mengalihkan ke Dashboard Admin...", "success");

        // Smooth transition before redirect
        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 1000);
      } else {
        if (loginBtn) {
          loginBtn.disabled = false;
          loginBtn.innerHTML = `
            <span class="btn-content">
              <span class="btn-icon">üëë</span>
              <span class="btn-text">Masuk ke Admin Panel</span>
            </span>
          `;
        }
        showNotification(data.error || "Login admin gagal", "error");
      }
    } catch (err) {
      if (loginBtn) {
        loginBtn.disabled = false;
        loginBtn.innerHTML = `
          <span class="btn-content">
            <span class="btn-icon">üëë</span>
            <span class="btn-text">Masuk ke Admin Panel</span>
          </span>
        `;
      }
      console.error('Admin Login Error:', err);
      showNotification("Gagal terhubung ke server admin", "error");
    }
  }

  // Admin-specific register function
  async function doAdminRegister() {
    const nama = document.getElementById("registerUsername")?.value?.trim();
    const email = document.getElementById("registerEmail")?.value?.trim();
    const password = document.getElementById("registerPassword")?.value;
    const registerBtn = document.getElementById("registerForm")?.querySelector("button.primary");

    if (!nama || !email || !password) {
      showNotification("Username, email, dan password admin wajib diisi", "warning");
      return;
    }

    if (!email.includes('@gmail')) {
      showNotification("Email admin harus menggunakan domain @gmail", "warning");
      return;
    }

    // Show loading state
    if (registerBtn) {
      registerBtn.disabled = true;
      registerBtn.innerHTML = `
        <span style="display: inline-flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: enterpriseSpin 1s linear infinite;"></div>
          Mendaftarkan...
        </span>
      `;
    }

    try {
      const res = await fetch(`${API_BASE}/admin/register/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nama, email, password, admin_code: 'ADMIN2025' }),
      });

      if (!res.ok) {
        if (registerBtn) {
          registerBtn.disabled = false;
          registerBtn.innerHTML = `
            <span class="btn-content">
              <span class="btn-icon">üéØ</span>
              <span class="btn-text">Buat Akun Admin</span>
            </span>
          `;
        }

        if (res.status === 400) {
          const errorData = await res.json();
          showNotification(errorData.error || "Data registrasi admin tidak valid", "error");
          return;
        } else if (res.status >= 500) {
          showNotification("Server mengalami masalah. Coba lagi nanti.", "error");
          return;
        } else {
          showNotification("Gagal terhubung ke server", "error");
          return;
        }
      }

      const data = await res.json();

      if (data.success) {
        if (registerBtn) {
          registerBtn.disabled = false;
          registerBtn.innerHTML = `
            <span class="btn-content">
              <span class="btn-icon">üéØ</span>
              <span class="btn-text">Buat Akun Admin</span>
            </span>
          `;
        }
        showNotification("Registrasi admin berhasil! Mengalihkan ke login...", "success");

        // Smooth transition to login tab
        setTimeout(() => {
          if (document.getElementById("tabLogin")) document.getElementById("tabLogin").click();
        }, 1500);
      } else {
        if (registerBtn) {
          registerBtn.disabled = false;
          registerBtn.innerHTML = `
            <span class="btn-content">
              <span class="btn-icon">üéØ</span>
              <span class="btn-text">Buat Akun Admin</span>
            </span>
          `;
        }
        showNotification(data.error || "Registrasi admin gagal", "error");
      }
    } catch (err) {
      if (registerBtn) {
        registerBtn.disabled = false;
        registerBtn.innerHTML = `
          <span class="btn-content">
            <span class="btn-icon">üéØ</span>
            <span class="btn-text">Buat Akun Admin</span>
          </span>
        `;
      }
      console.error('Admin Register Error:', err);
      showNotification("Gagal terhubung ke server admin", "error");
    }
  }

  // Navigate to user login
  function goToUserLogin() {
    window.location.href = "index.html?direct=login";
  }

  // Enhanced Tab Switching with Animations
  const loginTab = document.getElementById("tabLogin");
  const registerTab = document.getElementById("tabRegister");
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");

  function switchToLogin() {
    loginTab.classList.add("active");
    loginTab.classList.remove("inactive");
    registerTab.classList.remove("active");
    registerTab.classList.add("inactive");

    // Smooth transition
    loginForm.style.opacity = "0";
    registerForm.style.opacity = "0";

    setTimeout(() => {
      loginForm.style.display = "block";
      registerForm.style.display = "none";

      setTimeout(() => {
        loginForm.style.opacity = "1";
      }, 50);
    }, 150);
  }

  function switchToRegister() {
    registerTab.classList.add("active");
    registerTab.classList.remove("inactive");
    loginTab.classList.remove("active");
    loginTab.classList.add("inactive");

    // Smooth transition
    loginForm.style.opacity = "0";
    registerForm.style.opacity = "0";

    setTimeout(() => {
      loginForm.style.display = "none";
      registerForm.style.display = "block";

      setTimeout(() => {
        registerForm.style.opacity = "1";
      }, 50);
    }, 150);
  }

  loginTab.onclick = switchToLogin;
  registerTab.onclick = switchToRegister;

  // Enhanced Enter key support
  document.getElementById("loginPassword")?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") doAdminLogin();
  });
  document.getElementById("registerPassword")?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") doAdminRegister();
  });

  // Basic email validation for admin
  document.getElementById("registerEmail")?.addEventListener("blur", (e) => {
    const email = e.target.value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const isValid = email === "" || (emailRegex.test(email) && email.includes("@gmail.com"));

    e.target.classList.toggle("valid", isValid && email.length > 0);
    e.target.classList.toggle("invalid", !isValid && email.length > 0);
  });

  // Basic password validation for admin
  document.getElementById("registerPassword")?.addEventListener("blur", (e) => {
    const password = e.target.value;
    const isValid = password === "" || password.length >= 4;

    e.target.classList.toggle("valid", isValid && password.length > 0);
    e.target.classList.toggle("invalid", !isValid && password.length > 0);
  });

  // Basic username validation for admin
  document.getElementById("registerUsername")?.addEventListener("blur", (e) => {
    const username = e.target.value;
    const isValid = username === "" || username.length >= 3;

    e.target.classList.toggle("valid", isValid && username.length > 0);
    e.target.classList.toggle("invalid", !isValid && username.length > 0);
  });

  // Terms agreement validation
  document.getElementById("agreeTerms")?.addEventListener("change", (e) => {
    const registerBtn = document.querySelector(".register-btn");
    if (registerBtn) {
      registerBtn.disabled = !e.target.checked;
      registerBtn.style.opacity = e.target.checked ? "1" : "0.6";
    }
  });

  // Remember me functionality
  document.getElementById("rememberMe")?.addEventListener("change", (e) => {
    if (e.target.checked) {
      showNotification("Fitur 'Ingat Saya' akan menyimpan login admin Anda", "success", 3000);
    }
  });

  // Reset Password functionality
  document.querySelector(".forgot-password")?.addEventListener("click", (e) => {
    e.preventDefault();
    openResetModal();
  });

  function openResetModal() {
    const modal = document.getElementById("resetPasswordModal");
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";

    // Focus on email input
    setTimeout(() => {
      document.getElementById("resetEmail").focus();
    }, 100);
  }

  function closeResetModal() {
    const modal = document.getElementById("resetPasswordModal");
    modal.style.display = "none";
    document.getElementById("resetEmail").value = "";
  }

  function closeResetSuccessModal() {
    const modal = document.getElementById("resetSuccessModal");
    modal.style.display = "none";
  }

  function sendResetEmail() {
    const email = document.getElementById("resetEmail").value.trim();

    if (!email) {
      showNotification("Silakan masukkan email admin Anda", "error");
      return;
    }

    if (!email.includes("@gmail.com")) {
      showNotification("Email admin harus menggunakan domain @gmail.com", "error");
      return;
    }

    // Simulate sending reset email
    const resetBtn = event.target;
    const originalText = resetBtn.textContent;
    resetBtn.textContent = "Mengirim...";
    resetBtn.disabled = true;

    setTimeout(() => {
      // Close reset modal
      closeResetModal();

      // Show success modal
      const successModal = document.getElementById("resetSuccessModal");
      successModal.style.display = "flex";
      successModal.style.alignItems = "center";
      successModal.style.justifyContent = "center";

      // Reset button
      resetBtn.textContent = originalText;
      resetBtn.disabled = false;

      showNotification("Link reset password admin telah dikirim ke email Anda", "success");
    }, 2000);
  }

  // Close modals when clicking outside
  document.getElementById("resetPasswordModal")?.addEventListener("click", (e) => {
    if (e.target.id === "resetPasswordModal") {
      closeResetModal();
    }
  });

  document.getElementById("resetSuccessModal")?.addEventListener("click", (e) => {
    if (e.target.id === "resetSuccessModal") {
      closeResetSuccessModal();
    }
  });

  // Enter key support for reset email
  document.getElementById("resetEmail")?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      sendResetEmail();
    }
  });


  // Google Sign-In initialization for admin
  function initializeGoogleSignIn() {
    // Check if Google SDK is loaded
    if (typeof google === 'undefined' || !google.accounts || !google.accounts.id) {
      console.warn('Google Identity Services SDK not loaded yet, retrying...');
      setTimeout(initializeGoogleSignIn, 1000);
      return;
    }

    const clientId = 'YOUR_GOOGLE_CLIENT_ID_HERE'; // Replace with your actual Google Client ID

    if (clientId === 'YOUR_GOOGLE_CLIENT_ID_HERE') {
      // Show placeholder buttons with click handler for setup reminder
      const googleBtns = document.querySelectorAll(".google-btn");
      googleBtns.forEach(btn => {
        btn.innerHTML = '<span class="social-icon">üåê</span> Setup Google OAuth (Admin)';
        btn.onclick = (e) => {
          e.preventDefault();
          showNotification("Google Client ID belum dikonfigurasi. Silakan setup OAuth di Google Cloud Console terlebih dahulu.", "warning");
        };
      });
      return;
    }

    try {
      google.accounts.id.initialize({
        client_id: clientId,
        callback: handleGoogleSignIn,
        context: 'signin'
      });

      // Render Google Sign-In buttons for both login and register forms
      const googleBtns = document.querySelectorAll(".google-btn");
      googleBtns.forEach((btn, index) => {
        // Clear existing content
        btn.innerHTML = '';

        const buttonText = index === 0 ? 'continue_with' : 'signup_with';
        google.accounts.id.renderButton(btn, {
          theme: 'outline',
          size: 'large',
          text: buttonText,
          shape: 'rectangular',
          logo_alignment: 'left',
          width: '100%'
        });
      });

      console.log('Google Sign-In initialized successfully for admin');
    } catch (error) {
      console.error('Failed to initialize Google Sign-In:', error);
      // Fallback to manual button
      const googleBtns = document.querySelectorAll(".google-btn");
      googleBtns.forEach(btn => {
        btn.innerHTML = '<span class="social-icon">üåê</span> Google Login (Error)';
        btn.onclick = (e) => {
          e.preventDefault();
          showNotification("Gagal memuat Google Sign-In. Periksa koneksi internet.", "error");
        };
      });
    }
  }

  // Handle Google Sign-In response for admin
  async function handleGoogleSignIn(response) {
    if (!response.credential) {
      showNotification("Gagal mendapatkan credential dari Google", "error");
      return;
    }

    showLoading("Memproses login Google admin...");

    try {
      // Send Google ID token to backend for admin
      const res = await fetch(`${API_BASE}/auth/google/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${response.credential}`
        },
        body: JSON.stringify({
          id_token: response.credential,
          role: 'admin'
        }),
      });

      hideLoading();

      if (!res.ok) {
        if (res.status === 400) {
          const errorData = await res.json();
          showNotification(errorData.error || "Login Google admin gagal", "error");
        } else if (res.status === 404) {
          showNotification("Endpoint autentikasi Google belum tersedia di backend", "warning");
        } else {
          showNotification("Gagal terhubung ke server", "error");
        }
        return;
      }

      const data = await res.json();

      if (data.success) {
        // Check if user is admin
        if (data.user.role !== 'admin') {
          showNotification("Akun Google ini bukan akun administrator. Gunakan halaman login user.", "error");
          return;
        }

        setCurrentUser(data.user);
        showNotification("Login Google admin berhasil! Mengalihkan...", "success");

        // Smooth transition before redirect
        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 1000);
      } else {
        showNotification(data.error || "Login Google admin gagal", "error");
      }
    } catch (err) {
      hideLoading();
      console.error('Google Admin Login Error:', err);
      showNotification("Gagal terhubung ke server admin", "error");
    }
  }

  // Initialize form states
  document.addEventListener("DOMContentLoaded", () => {
    // Set initial opacity
    loginForm.style.opacity = "1";
    registerForm.style.opacity = "0";

    // Initialize Google Sign-In
    initializeGoogleSignIn();

    // Add loading class removal after animations
    setTimeout(() => {
      document.body.classList.add("loaded");
    }, 1000);
  });

  // Username input Enter key support
  document.getElementById("loginUsername").addEventListener("keypress", (e) => {
    if (e.key === "Enter") document.getElementById("loginPassword").focus();
  });
  document.getElementById("registerUsername").addEventListener("keypress", (e) => {
    if (e.key === "Enter") document.getElementById("registerEmail").focus();
  });
  document.getElementById("registerEmail").addEventListener("keypress", (e) => {
    if (e.key === "Enter") document.getElementById("registerPassword").focus();
  });
</script>

<script src="app.js"></script>

<!-- Copyright Footer -->
<footer class="copyright-footer">
  <p>&copy; 2025 InvManage. All rights reserved.</p>
  <div class="copyright-team">
    <div class="team-member">
      <div class="team-role">Software Architect & Developer</div>
      <div class="team-name">
        <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/eDuxj6_KTmf6YPT4mS22ImxLcI2AMpeH-UDBV4sZj3dkDlM-mOCRH1tohrHDnMuLchCNVg==" target="_blank">
          Alifito Rabbani Cahyono
        </a>
      </div>
    </div>
    <div class="team-member">
      <div class="team-role">UI/UX Architect & Developer</div>
      <div class="team-name">
        <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/NOLSmx8LbYciDdNeAiC78KLe0D79FgZs3AQQ-Rp0U9MwtQK3A48MEeHOf-_ZwbtJOMFwxw==" target="_blank">
          Satria Febry Andanu
        </a>
      </div>
    </div>
    <div class="team-member">
      <div class="team-role">Data Analyst & Engineer</div>
      <div class="team-name">
        <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/mhbV5ChTDJtuFBK7x0DFSQMCI7JObDTv_hYV9KHaAA3_Xioi_j3PO2C4_oiCFjQwte-7Ig==" target="_blank">
          Naufal Thafhan
        </a>
      </div>
    </div>
  </div>
</footer>
</body>
</html>