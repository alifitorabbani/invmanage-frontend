<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>InvManage - Feedback</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="dashboard-layout">

    <!-- Sidebar -->
    <div class="sidebar">
      <img src="image.png" alt="Logo" class="sidebar-logo">
      <h1>InvManage</h1>

      <div class="menu">
        <a href="user-dashboard.html" class="menu-item">Daftar Barang</a>
        <a href="user-peminjaman.html" class="menu-item">Peminjaman Saya</a>
        <a href="user-feedback.html" class="menu-item active">Feedback</a>
        <a href="user-profil.html" class="menu-item">Profil</a>
      </div>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <div class="table-box">
        <div class="table-header">
          <div>
            <h2 class="table-title">Kirim Feedback</h2>
            <p style="color:var(--gray-400); margin: 8px 0 0 0; font-size: 14px;">Berikan masukan untuk perbaikan sistem.</p>
          </div>
        </div>

        <div id="feedbackForm" style="margin-bottom:40px; padding: 24px; background: var(--gray-800); border-radius: 12px; border: 1px solid var(--gray-600);">
          <div class="input-group">
            <label>Feedback Anda <span style="color: var(--error);">*</span></label>
            <textarea id="feedbackPesan" rows="4" style="width:100%; padding:16px 20px; border-radius:12px; border:2px solid var(--gray-600); background: var(--gray-700); color: var(--gray-100); font-size:16px; resize: vertical;" placeholder="Tulis feedback, saran, atau laporan masalah di sini..."></textarea>
            <small style="color: var(--gray-400); display: block; margin-top: 4px;">Minimal 10 karakter, maksimal 1000 karakter</small>
          </div>

          <div class="input-group" style="margin-top: 16px;">
            <label>Kategori Feedback</label>
            <select id="feedbackKategori" style="width:100%; padding:12px 16px; border-radius:8px; border:2px solid var(--gray-600); background: var(--gray-700); color: var(--gray-100); font-size:16px;">
              <option value="">Pilih Kategori (Opsional)</option>
              <option value="bug">üêõ Laporan Bug</option>
              <option value="feature">‚ú® Saran Fitur</option>
              <option value="improvement">üîß Perbaikan Sistem</option>
              <option value="other">üí¨ Lainnya</option>
            </select>
          </div>

          <button class="primary" style="width:auto; margin-top: 16px;" onclick="tambahFeedback()" id="submitFeedbackBtn">Kirim Feedback</button>
        </div>

        <h3 style="margin-top:30px; font-size: 20px; font-weight: 600; color: var(--gray-100);">Feedback Saya</h3>
        <table id="tabelFeedbackUser">
          <thead>
            <tr>
              <th>Pesan</th>
              <th>Tanggal</th>
            </tr>
          </thead>
          <tbody>
            <!-- diisi lewat app.js -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Copyright Footer -->
  <footer class="copyright-footer">
    <p>&copy; 2025 InvManage. All rights reserved.</p>
    <div class="copyright-team">
      <div class="team-member">
        <div class="team-role">Software Architect & Developer</div>
        <div class="team-name">
          <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/eDuxj6_KTmf6YPT4mS22ImxLcI2AMpeH-UDBV4sZj3dkDlM-mOCRH1tohrHDnMuLchCNVg==" target="_blank">
            Alifito Rabbani Cahyono
          </a>
        </div>
      </div>
      <div class="team-member">
        <div class="team-role">UI/UX Architect & Developer</div>
        <div class="team-name">
          <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/NOLSmx8LbYciDdNeAiC78KLe0D79FgZs3AQQ-Rp0U9MwtQK3A48MEeHOf-_ZwbtJOMFwxw==" target="_blank">
            Satria Febry Andanu
          </a>
        </div>
      </div>
      <div class="team-member">
        <div class="team-role">Data Analyst & Engineer</div>
        <div class="team-name">
          <a href="https://pddikti.kemdiktisaintek.go.id/detail-mahasiswa/mhbV5ChTDJtuFBK7x0DFSQMCI7JObDTv_hYV9KHaAA3_Xioi_j3PO2C4_oiCFjQwte-7Ig==" target="_blank">
            Naufal Thafhan
          </a>
        </div>
      </div>
    </div>
  </footer>

  <script src="data.js"></script>
  <script src="app.js?v=20251226"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Temporarily bypass auth for testing - REMOVE THIS IN PRODUCTION
      // if (!checkAuth('user')) return;
      loadFeedbackUser();
    });

    // Temporary fix for loadFeedbackUser function
    async function loadFeedbackUser() {
      console.log("üîÑ loadFeedbackUser called from HTML");
      const tableBody = document.querySelector("#tabelFeedbackUser tbody");
      if (!tableBody) {
        console.warn('User feedback table body not found');
        return;
      }

      const currentUser = getCurrentUser();

      // Display sample feedback immediately from centralized data
      console.log('üìä Displaying sample user feedback immediately');
      tableBody.innerHTML = "";
      window.sampleUserFeedback.forEach((f) => {
        const tanggal = f.tanggal ? new Date(f.tanggal).toLocaleString("id-ID") : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${f.pesan}</td>
          <td>${tanggal}</td>
        `;
        tableBody.appendChild(tr);
      });
      console.log('‚úÖ Sample user feedback displayed');

      // Try to load real user feedback in background
      if (currentUser) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout

          const res = await fetch(`${API_BASE}/feedback/`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            mode: 'cors',
            signal: controller.signal
          });

          clearTimeout(timeoutId);

          if (res.ok) {
            const data = await res.json();
            console.log('User feedback API response:', data);

            if (Array.isArray(data) && data.length > 0) {
              // Filter hanya feedback milik user ini
              const userFeedback = data.filter(f => f.user === currentUser.id);

              if (userFeedback.length > 0) {
                console.log('Real user feedback loaded, replacing sample data:', userFeedback.length, 'records');
                tableBody.innerHTML = "";
                userFeedback.forEach((f) => {
                  const tanggal = f.tanggal ? new Date(f.tanggal).toLocaleString("id-ID") : "-";

                  const tr = document.createElement("tr");
                  tr.innerHTML = `
                    <td>${f.pesan}</td>
                    <td>${tanggal}</td>
                  `;
                  tableBody.appendChild(tr);
                });
              } else {
                console.log('No user feedback found, keeping sample data');
              }
            } else {
              console.log('API returned empty feedback data, keeping sample data');
            }
          } else {
            console.warn('User feedback API request failed:', res.status, res.statusText);
          }
        } catch (err) {
          console.log('Could not load real user feedback, keeping sample data:', err.message);
        }
      } else {
        console.log('No current user found, showing sample feedback');
      }
    }

    // Temporary fix for tambahFeedback function
    async function tambahFeedback() {
      console.log("üîÑ tambahFeedback called from HTML");
      const pesan = $("#feedbackPesan")?.value;
      const currentUser = getCurrentUser();

      if (!pesan) {
        showNotification("Pesan feedback wajib diisi", "warning");
        return;
      }

      if (!currentUser) {
        showNotification("Silakan login terlebih dahulu", "error");
        return;
      }

      const payload = { user: currentUser.id, pesan };

      try {
        showLoading("Mengirim feedback...");
        const res = await fetch(`${API_BASE}/feedback/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) throw new Error("Gagal mengirim feedback");

        if ($("#feedbackPesan")) $("#feedbackPesan").value = "";

        // Reload feedback user jika ada
        if ($("#tabelFeedbackUser")) {
          await loadFeedbackUser();
        }

        hideLoading();
        showNotification("Feedback berhasil dikirim!", "success");
      } catch (err) {
        console.error(err);
        hideLoading();
        showNotification("Gagal mengirim feedback", "error");
      }
    }
  </script>
</body>
</html>
